# Kalima Repository Structure

## Root Directory
```
Kalima/
├── Kalima.exe          # Desktop application executable (20MB)
├── desktop/            # Frontend (Tauri wrapper + web assets)
├── data/               # Runtime data (database + search index)
├── datasets/           # Source data for ingestion
├── engine/             # Rust backend (4 crates)
├── README.md           # Project documentation
├── CHANGELOG.md        # Version history
└── .gitignore          # Git ignore rules
```

## Core Components

### 1. Desktop Application (desktop/)
```
desktop/
├── src-tauri/          # Tauri desktop wrapper
│   ├── src/
│   │   ├── lib.rs      # Tauri setup, path configuration
│   │   └── main.rs     # Entry point
│   ├── tauri.conf.json # Tauri configuration
│   ├── Cargo.toml      # Dependencies
│   └── icons/          # Application icons
└── web/                # Frontend assets (HTML, CSS, JS)
    ├── index.html      # Main HTML
    ├── css/
    │   └── minimal.css # Styles
    └── js/             # 17 modular JavaScript files
        ├── app*.js     # Application logic
        └── canvas*.js  # Canvas rendering
```

**Kalima.exe** - Tauri-wrapped desktop app
- Embeds Rust API server
- Opens native window
- Loads from data/database/ and data/search-index/

### 2. Backend (engine/)
```
engine/
├── api/                # Web server + API endpoints
│   ├── src/
│   │   ├── lib.rs      # Server library (start_server())
│   │   ├── main.rs     # CLI entry point
│   │   └── bin/ingest.rs  # Data ingestion tool
│   └── Cargo.toml
├── core/               # Core types and traits
├── store/              # SQLite storage backend
├── search/             # Tantivy search backend
└── Cargo.toml          # Workspace configuration
```

### 3. Runtime Data (data/)
```
data/
├── database/           # SQLite database
│   └── kalima.db       # (33MB, generated by ingest)
└── search-index/       # Tantivy search index
                        # (generated by ingest)
```

### 4. Source Data (datasets/)
```
datasets/
└── corpus/
    └── quran.jsonl     # Source corpus (6,236 verses, 23MB)
```

## Data Flow

1. **Ingestion** (one-time):
   ```
   datasets/corpus/quran.jsonl
     → ingest tool
       → data/database/kalima.db (SQLite)
       → data/search-index/ (Tantivy)
   ```

2. **Desktop App Launch**:
   ```
   Kalima.exe
     → starts api::start_server()
       → loads data/database/kalima.db
       → loads data/search-index/
       → serves desktop/web/
     → opens Tauri window at http://127.0.0.1:8080
   ```

3. **API Request**:
   ```
   Frontend (desktop/web/js)
     → HTTP request to localhost:8080/api/verse/1/1
       → store queries SQLite
       → returns verse with tokens/segments
     → Frontend renders verse
   ```

## Crate Architecture

The `engine/` workspace contains 4 crates:

1. **api** - Web server and API endpoints
   - Depends on: core, store, search
   - Embeds: desktop/web/ assets via RustEmbed
   - 50+ REST endpoints

2. **core** - Core types and traits
   - No external dependencies within workspace
   - Defines: SegmentView, Annotation, traits

3. **store** - SQLite storage backend
   - Depends on: core
   - Implements: StorageBackend trait

4. **search** - Tantivy search backend
   - Depends on: core
   - Implements: SearchBackend trait

## What's NOT Needed

The following were removed as unused:
- ~~archive/~~ (old CSS)
- ~~schema/~~ (outdated)
- ~~deploy/~~ (server configs, not needed for desktop)
- ~~Dockerfile, docker-compose.yml~~ (not needed for desktop)
- ~~*.backup files~~ (backups)
- ~~nul files~~ (Windows artifacts)

## Build Commands

```bash
# First-time setup
cd engine
cargo run --release --bin ingest -- --db ../data/database/kalima.db --index ../data/search-index --input ../datasets/corpus/quran.jsonl

# Build desktop app
cargo tauri build
cp desktop/src-tauri/target/release/app.exe Kalima.exe

# Run desktop app
./Kalima.exe
```

## Benefits of This Structure

1. **Clear Separation**: Frontend (desktop/), Backend (engine/), Data (data/), Source (datasets/)
2. **Professional Naming**: Crates named by function (api, core, store, search) not by project
3. **No Naming Collisions**: data/search-index/ vs engine/search/ - clear distinction
4. **Grouped by Concern**: All frontend files together, all backend crates together
5. **Flat Hierarchy**: Easy to navigate, clear boundaries
6. **Runtime Isolation**: Runtime data separate from source code
