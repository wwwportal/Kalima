<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Codex - Quran Research Canvas</title>
    <link rel="stylesheet" href="/static/css/minimal.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Scheherazade+New:wght@400;700&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Minimal Top Bar -->
    <header class="minimal-header">
        <button id="menuToggle" class="menu-toggle">‚ò∞</button>
        <div class="header-spacer"></div>
        <button id="patternToggle" class="menu-toggle" title="Toggle details &amp; results panel">üîç</button>
    </header>

    <!-- Collapsible Side Menu -->
    <aside id="sideMenu" class="side-menu collapsed">
        <div class="menu-content">
            <div id="sideStacks" class="stacked-panels">
                <div class="stack-panel" data-panel="surah">
                    <div class="stack-header" draggable="true">
                        <span>Surah / Ayah</span>
                        <button class="stack-toggle" aria-label="Collapse">?</button>
                    </div>
                    <div class="stack-body">
                        <div id="surahTree" class="surah-tree">
                            <p class="hint">Select a surah to expand and jump to its ayahs.</p>
                        </div>
                    </div>
                </div>

                <div class="stack-panel" data-panel="roots">
                    <div class="stack-header" draggable="true">
                        <span>Root Explorer</span>
                        <button class="stack-toggle" aria-label="Collapse">?</button>
                    </div>
                    <div class="stack-body">
                        <div id="rootLetterRow" class="letter-chip-row"></div>
                        <div id="rootChipContainer" class="search-chip-container">
                            <p class="hint">Select a letter to view available roots.</p>
                        </div>
                    </div>
                </div>

                <div class="stack-panel" data-panel="navmap">
                    <div class="stack-header" draggable="true">
                        <span>Navigation Map</span>
                        <button class="stack-toggle" aria-label="Collapse">?</button>
                    </div>
                    <div class="stack-body">
                        <div id="navMap" class="nav-map">
                            <p class="hint">Your navigation history will appear as a map.</p>
                        </div>
                    </div>
                </div>

                <div class="stack-panel" data-panel="pattern">
                    <div class="stack-header" draggable="true">
                        <span>Diacritic Pattern Search</span>
                        <button class="stack-toggle" aria-label="Collapse">?</button>
                    </div>
                    <div class="stack-body">
                        <div class="pattern-search">
                            <label class="pattern-label">Arabic keyword</label>
                            <div class="pattern-input">
                                <input type="text" id="patternInput" class="input" placeholder="Enter an Arabic word to pattern-match" />
                                <button type="button" class="pattern-btn" id="patternBreakBtn" title="Break word into letters and diacritics">Split</button>
                            </div>
                            <div class="pattern-actions">
                                <label><input type="checkbox" id="patternAllowPrefix" /> Allow prefix</label>
                                <label><input type="checkbox" id="patternAllowSuffix" /> Allow suffix</label>
                            </div>
                            <div id="patternSegments" class="pattern-segments">
                                <p class="hint">Break a word to edit per-letter pattern.</p>
                            </div>
                            <div class="pattern-actions">
                                <button type="button" class="btn btn-primary" id="patternSearchBtn">Search Pattern</button>
                            </div>
                            <p class="hint small">Toggle letters/diacritics to "any" for flexible matches.</p>
                        </div>
                    </div>
                </div>

                <div class="stack-panel" data-panel="morph">
                    <div class="stack-header" draggable="true">
                        <span>Morphological Builder</span>
                        <button class="stack-toggle" aria-label="Collapse">?</button>
                    </div>
                    <div class="stack-body">
                        <div id="morphBuilder" class="builder-field" data-builder="morph"></div>
                        <div class="builder-actions">
                            <div id="morphChipRow" class="chip-row"></div>
                            <div>
                                <button type="button" class="btn" id="morphClearBtn">Clear</button>
                                <button type="button" class="btn btn-primary" id="morphBuildSearch">Search</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="stack-panel" data-panel="syntax">
                    <div class="stack-header" draggable="true">
                        <span>Syntactic Builder</span>
                        <button class="stack-toggle" aria-label="Collapse">?</button>
                    </div>
                    <div class="stack-body">
                        <div id="syntaxBuilder" class="builder-field" data-builder="syntax"></div>
                        <div class="builder-actions">
                            <div id="syntaxChipRow" class="chip-row"></div>
                            <div>
                                <button type="button" class="btn" id="syntaxClearBtn">Clear</button>
                                <button type="button" class="btn btn-primary" id="syntaxBuildSearch">Search</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="stack-panel" data-panel="library">
                    <div class="stack-header" draggable="true">
                        <span>Library &amp; Notes</span>
                        <button class="stack-toggle" aria-label="Collapse">?</button>
                    </div>
                    <div class="stack-body">
                        <input type="text" id="librarySearchInput" class="input" placeholder="Search notes &amp; bookmarks" />
                        <div class="builder-actions">
                            <button type="button" class="btn btn-primary" id="librarySearchBtn">Search Library</button>
                        </div>
                        <div id="notesList" class="notes-list">
                            <p class="hint">Notes will load here.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </aside>

    <!-- Details & Results Panel -->
    <aside id="patternPanel" class="pattern-panel collapsed" aria-label="Details and results">
        <div class="panel-header">
            <h2>Details &amp; Results</h2>
            <div class="panel-controls">
                <button id="layerUp" class="panel-btn" title="Go up layer (sentence ‚Üê word)">‚Üë</button>
                <span id="currentDetailLayer" class="layer-indicator">Verse</span>
                <button id="layerDown" class="panel-btn" title="Go down layer (word ‚Üí segment)">‚Üì</button>
            </div>
            <button id="closePatternPanel" class="panel-close" aria-label="Hide panel">√ó</button>
        </div>
        <div id="elementDetails" class="element-details">
            <p class="hint">Click on any element to inspect its structure.</p>
        </div>
        <div class="structure-panel">
            <h3>Structure Tagging</h3>
            <div class="structure-palette">
                <span class="palette-label">Type:</span>
                <div id="layerPalette" class="palette-options"></div>
            </div>
            <p class="hint">Select a type, then click an element to tag.</p>
        </div>
        <div id="hypothesisPanel" class="hypothesis-panel">
            <h3>Hypotheses</h3>
            <div id="hypothesisList" class="hypothesis-list">
                <p class="hint">No hypotheses yet.</p>
            </div>
            <form id="hypothesisForm" class="hypothesis-form">
                <div id="hypTargetDisplay" class="hyp-target">No selection</div>
                <label>Hypothesis / Referent</label>
                <input id="hypText" type="text" placeholder="Hypothesis text" />
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Save Hypothesis</button>
                </div>
            </form>
        </div>
        <div id="actionHistory" class="action-history">
            <p class="hint">Recent actions will appear here.</p>
        </div>
        <div id="searchResults" class="search-results panel-results">
            <p class="hint">Use the search builders to explore occurrences.</p>
        </div>
    </aside>

    <!-- Main Canvas - Just the Quran Text -->
    <main id="canvas" class="canvas">
        <!-- Lightweight navigation controls for testing and basic use -->
        <section class="nav-controls">
            <div class="nav-row">
                <button id="prevBtn" class="btn">Previous</button>
                <label>
                    Surah
                    <input id="surahInput" type="number" min="1" class="input nav-input" />
                </label>
                <label>
                    Ayah
                    <input id="ayahInput" type="number" min="1" class="input nav-input" />
                </label>
                <button id="goBtn" class="btn">Go</button>
                <button id="nextBtn" class="btn">Next</button>
            </div>
            <div id="verseTitle" class="verse-title"></div>
            <div id="verseText" class="verse-text"></div>
            <div id="tokensContainer" class="token-panel"></div>
            <div id="annotationsContainer" class="annotation-panel"></div>
            <div class="nav-row">
                <label>
                    Quick search
                    <input id="quickSearch" type="text" class="input nav-input" placeholder="Search..." />
                </label>
                <label>
                    Type
                    <select id="searchType" class="input nav-input">
                        <option value="text">Text</option>
                        <option value="root">Root</option>
                        <option value="morphology">Morphology</option>
                    </select>
                </label>
            </div>
            <div class="nav-row nav-toggles">
                <label><input id="showTokens" type="checkbox" checked /> Show tokens</label>
                <label><input id="showMorphology" type="checkbox" /> Show morphology</label>
                <label><input id="showAnnotations" type="checkbox" checked /> Show annotations</label>
            </div>
            <div id="verseInfo" class="info-panel"></div>
            <div id="detailsPanel" class="details-panel"></div>
        </section>

        <!-- Verse Reference -->
        <div class="verse-reference" id="verseReference"></div>

        <!-- The Sacred Text (Interactive) -->
        <div class="quran-text" id="quranText">
            <!-- Words will be rendered here as interactive elements -->
        </div>

        <!-- SVG Overlay for Connections -->
        <svg id="connectionCanvas" class="connection-canvas"></svg>

        <!-- Edge Indicators -->
        <div class="edge-indicators">
            <div class="edge-indicator edge-top" id="edgeTop"></div>
            <div class="edge-indicator edge-right" id="edgeRight"></div>
            <div class="edge-indicator edge-bottom" id="edgeBottom"></div>
            <div class="edge-indicator edge-left" id="edgeLeft"></div>
        </div>
    </main>

    <!-- Hover Tooltip -->
    <div id="textTooltip" class="text-tooltip hidden"></div>

    <!-- Pattern Definition Modal -->
    <div id="patternModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2>Define New Pattern</h2>
            <form id="patternForm">
                <label>Pattern Name:</label>
                <input type="text" id="patternName" required />

                <label>Pattern Type:</label>
                <select id="patternType">
                    <option value="morphological">Morphological</option>
                    <option value="syntactic">Syntactic</option>
                    <option value="thematic">Thematic</option>
                    <option value="phonological">Phonological</option>
                </select>

                <label>Description:</label>
                <textarea id="patternDescription" rows="4"></textarea>

                <label>Apply to entire corpus?</label>
                <input type="checkbox" id="applyCorpus" />

                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">Save Pattern</button>
                    <button type="button" class="btn" id="cancelPattern">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- App Module Scripts -->
    <script src="/static/js/app.js"></script>
    <script src="/static/js/app-api.js"></script>
    <script src="/static/js/app-display.js"></script>
    <script src="/static/js/app-events.js"></script>

    <!-- Layer System -->
    <script src="/static/js/layers.js"></script>

    <!-- Canvas Module Scripts - Load in correct order -->
    <script src="/static/js/canvas-config.js"></script>
    <script src="/static/js/canvas.js"></script>
    <script src="/static/js/canvas-utils.js"></script>
    <script src="/static/js/canvas-core.js"></script>
    <script src="/static/js/canvas-surah.js"></script>
    <script src="/static/js/canvas-search.js"></script>
    <script src="/static/js/canvas-patterns.js"></script>
    <script src="/static/js/canvas-hypotheses.js"></script>
    <script src="/static/js/canvas-rendering.js"></script>
    <script src="/static/js/canvas-selection.js"></script>
    <script src="/static/js/canvas-annotations.js"></script>
</body>
</html>
